 - hosts: web
   name: Patch  Redhat system 
   gather_facts: false
   become_user: root
   become_method: sudo
   #ansible_host_key_checking: false
   tasks:
     - name: "Copy Patch script From local system to all managed  nodes "
       copy:
          src: ./linux.sh
          dest: /tmp
          owner: root
          mode: 0777
# Copy script on remote hosts   
     - name: "using shell module for executing script "
       shell: ./linux.sh
       args:
          chdir: /tmp
       register: result
     - debug:
        var: result
# this task is to check if kernel update happend and system needs reboot ot not
     - name: check if reboot required after kernel update.
       shell: KERNEL_NEW=$(rpm -q --last kernel |head -1 | awk '{print $1}' | sed 's/kernel-//'); KERNEL_NOW=$(uname -r); if [[ $KERNEL_NEW != $KERNEL_NOW ]]; then echo "reboot_needed"; else echo "reboot_not_needed"; fi
       ignore_errors: true
       register: reboot_required
       tags:
        - task4
# this task is to restart the system
     - name: restart system
       command: shutdown -r +1  "Rebooting System After Patching"
       async: 0
       poll: 0
       when: reboot_required.stdout == "reboot_needed"
       register: reboot_started
       ignore_errors: true
       tags:
        - tsak5 

    # this task is to wait for 3  minutues for system to come up after the reboot
     - name: pause for 120 secs
       pause:
         minutes: 3
         tags:
          - task6

    # this task is to confirm,system is up and responding to ssh
     - name: check if system responding to ssh
       local_action:
        - module:
           wait_for:
             host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
             port: 22
             delay: 15
             timeout: 300
             state: started
             when: reboot_started|changed
             tags:
              - task7   

        
